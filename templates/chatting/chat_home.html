{% extends 'chatting/base_chat.html' %}
{% load static %}

{% block chat_content %}
<div class="contacts">
    <h3>Recent Chats</h3>
    <div id="contacts-list">
        {% if conversations %}
            {% for conversation in conversations %}
                <a href="{% url 'chatting:conversation_detail' conversation.id %}" class="contact-link">
                    <div class="contact {% if conversation.unread_count %}has-unread{% endif %}">
                        <div class="contact-header">
                            <span>{{ conversation.other_user.get_full_name|default:conversation.other_user.username }}</span>
                            <span class="status-indicator {% if conversation.other_user.chat_status.is_online %}online{% else %}offline{% endif %}"></span>
                            {% if conversation.unread_count %}
                                <span class="unread-badge">{{ conversation.unread_count }}</span>
                            {% endif %}
                        </div>
                        <span class="last-activity">
                            {% if conversation.last_message %}
                                {% if conversation.last_message.sender == request.user %}
                                    You: {{ conversation.last_message.content|truncatechars:30 }}
                                {% else %}
                                    {{ conversation.last_message.content|truncatechars:30 }}
                                {% endif %}
                                â€¢ {{ conversation.last_message.timestamp|timesince }} ago
                            {% else %}
                                No messages yet
                            {% endif %}
                        </span>
                    </div>
                </a>
            {% endfor %}
        {% else %}
            <div class="no-contacts">No recent chats</div>
        {% endif %}
    </div>
    
    <h3 class="mt-4">Start New Chat</h3>
    <div id="available-users">
        {% if available_users %}
            {% for user in available_users %}
                <a href="{% url 'chatting:start_conversation' user.id %}" class="contact-link">
                    <div class="contact new-chat">
                        <div class="contact-header">
                            <span>{{ user.get_full_name|default:user.username }}</span>
                            <span class="status-indicator {% if user.chat_status.is_online %}online{% else %}offline{% endif %}"></span>
                        </div>
                        <span class="last-activity">
                            {% if user.chat_status.is_online %}
                                Online now
                            {% else %}
                                {% if user.chat_status.last_active %}
                                    Last seen: {{ user.chat_status.last_active|timesince }} ago
                                {% else %}
                                    Offline
                                {% endif %}
                            {% endif %}
                        </span>
                    </div>
                </a>
            {% endfor %}
        {% else %}
            <div class="no-contacts">No users available</div>
        {% endif %}
    </div>
</div>

<div class="messages-container">
    <div class="empty-state">
        <div class="empty-state-content">
            <i class="fas fa-comments empty-icon"></i>
            <h2>Select a conversation</h2>
            <p>Choose an existing chat or start a new one</p>
        </div>
    </div>
</div>
{% endblock %}

{% block chat_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Connect to user status WebSocket
    connectToUserStatus();

    function connectToUserStatus() {
        const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
        const wsUrl = `${wsScheme}://${window.location.host}/ws/user_status/`;
        
        const statusSocket = new WebSocket(wsUrl);
        
        statusSocket.onopen = function(e) {
            console.log('User status connection established');
        };
        
        statusSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.type === 'status_update') {
                updateUserStatus(data.user_id, data.status);
            }
        };
        
        statusSocket.onclose = function(e) {
            console.log('User status connection closed');
            // Try to reconnect after a delay
            setTimeout(function() {
                connectToUserStatus();
            }, 3000);
        };
        
        statusSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
        };
    }

    function updateUserStatus(userId, status) {
        // Find all status indicators for this user and update them
        const statusIndicators = document.querySelectorAll(`.user-${userId} .status-indicator`);
        statusIndicators.forEach(indicator => {
            if (status === 'online') {
                indicator.classList.remove('offline');
                indicator.classList.add('online');
            } else {
                indicator.classList.remove('online');
                indicator.classList.add('offline');
            }
        });
        
        // Update last activity text
        const lastActivity = document.querySelector(`.user-${userId} .last-activity`);
        if (lastActivity) {
            if (status === 'online') {
                lastActivity.textContent = 'Online now';
            } else {
                lastActivity.textContent = 'Last seen just now';
            }
        }
    }
});
</script>
{% endblock %}