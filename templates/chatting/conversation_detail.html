{% extends 'chatting/base_chat.html' %}
{% load static %}

{% block title %}Chat with {{ other_user.username }} | E-Platform{% endblock %}

{% block chat_content %}
<div class="container">
    <div class="contacts">
        <h3>
            <a href="{% url 'chatting:chat_home' %}" class="back-to-chats">
                <i class="fas fa-arrow-left"></i>
            </a>
            Conversations
        </h3>
        <div id="contacts-list">
            {% if conversations %}
                {% for conv in conversations %}
                <a href="{% url 'chatting:conversation_detail' conv.id %}" class="contact-link">
                    <div class="contact {% if conv.id == conversation.id %}active{% endif %} {% if conv.unread_count > 0 %}has-unread{% endif %}">
                        <div class="contact-header">
                            <span>{{ conv.other_user.username }}</span>
                            <span class="status-indicator {% if conv.other_user.chat_status.is_online %}online{% else %}offline{% endif %}"
                                  data-user-id="{{ conv.other_user.id }}"
                                  title="{{ conv.other_user.chat_status.is_online|yesno:'Online,Offline' }}">
                            </span>
                        </div>
                        <div class="conversation-preview">
                            <span>
                                {% if conv.messages.last %}
                                    {{ conv.messages.last.content|truncatechars:30 }}
                                {% else %}
                                    Start a conversation
                                {% endif %}
                            </span>
                            {% if conv.unread_count > 0 %}
                                <span class="unread-badge">{{ conv.unread_count }}</span>
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <div class="no-contacts">
                    <p>No conversations yet</p>
                    <p>Start a new conversation by visiting the <a href="{% url 'chatting:users_list' %}">Users</a> page</p>
                </div>
            {% endif %}
        </div>

        <div class="contacts-footer">
            <a href="{% url 'chatting:users_list' %}" class="new-chat-btn">
                <i class="fas fa-plus"></i> New Chat
            </a>
        </div>
    </div>

    <div class="messages-container">
        <div class="chat-header">
            <button class="menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="current-chat-user">
                <div class="profile-image">
                    {% if other_user.profile_picture %}
                        <img src="{{ other_user.profile_picture.url }}" alt="{{ other_user.username }}" class="user-img">
                    {% else %}
                        <img src="{% static 'chatting/images/default_avatar.svg' %}" alt="{{ other_user.username }}" class="user-img">
                    {% endif %}
                    <span class="status-indicator {% if other_user.chat_status.is_online %}online{% else %}offline{% endif %}"
                          data-user-id="{{ other_user.id }}">
                    </span>
                </div>
                <div class="user-info">
                    <h4>{{ other_user.get_full_name|default:other_user.username }}</h4>
                    <div class="user-status">
                        <span class="status-text">
                            {% if other_user.chat_status.is_online %}
                                Online
                            {% else %}
                                {% if other_user.chat_status.last_active %}
                                    Last seen {{ other_user.chat_status.last_active|timesince }} ago
                                {% else %}
                                    Offline
                                {% endif %}
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div id="message-list" class="message-list">
            {% if messages %}
                {% for message in messages %}
                    <div class="message-item {% if message.sender == request.user %}outgoing{% else %}incoming{% endif %}">
                        <div class="message-content">
                            {{ message.content }}
                        </div>
                        <div class="message-meta">
                            <span class="message-time">{{ message.timestamp|time:"g:i A" }}</span>
                            {% if message.sender == request.user %}
                                <span class="message-status">
                                    <i class="fas fa-{% if message.is_read %}check-double read-indicator{% else %}check{% endif %}"></i>
                                </span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty-messages">
                    <p>No messages yet. Start the conversation!</p>
                </div>
            {% endif %}

            <div id="typing-indicator" class="typing-indicator" style="display: none;">
                {{ other_user.username }} is typing...
            </div>
        </div>

        <form id="message-form" class="message-input">
            <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off">
            <button type="submit">Send</button>
        </form>
    </div>
</div>
{% endblock %}

{% block chat_js %}
<script src="{% static 'chatting/js/chat.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize WebSocket connection
        window.chatSocket = initializeChatWebsocket();

        // Initialize conversation
        initializeConversation(
            {{ conversation.id }},
            {{ request.user.id }},
            {{ other_user.id }}
        );

        // Scroll to the bottom of the message list
        const messageList = document.getElementById('message-list');
        if (messageList) {
            messageList.scrollTop = messageList.scrollHeight;
        }

        // Add animation classes to message items
        const messageItems = document.querySelectorAll('.message-item');
        if (messageItems.length > 0) {
            messageItems.forEach(function(item, index) {
                setTimeout(function() {
                    item.classList.add('visible');
                }, index * 50); // Stagger the animations
            });
        }
    });
</script>
{% endblock %}
