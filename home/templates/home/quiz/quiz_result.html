{% extends 'home/base_home.html' %}
{% load static %}
{% load math_filters %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'home/css/quiz.css' %}">
<link rel="stylesheet" href="{% static 'home/css/monster_quiz.css' %}">
<link rel="stylesheet" href="{% static 'home/css/responsive_results.css' %}">
{% endblock %}

{% block home_content %}
<div class="monster-quiz-container">
    <div class="quiz-header monster-header">
        <div class="monster-eyes">
            <div class="monster-eye"></div>
            <div class="monster-eye"></div>
        </div>
        <h1 class="quiz-monster-title">Challenge Complete!</h1>
    </div>

    <div class="monster-results-container">
        <div class="monster-results-header">
            <h2 class="monster-results-title">{{ quiz.title }} Results</h2>
            <div class="monster-detail-subject">{{ quiz.subject.name }}</div>
        </div>
        <div class="monster-results-badge">
            <div class="monster-score-value">{{ score_percent|floatformat:1 }}%</div>
            <div class="monster-score-label">Score</div>
        </div>
        <div class="monster-results-summary">
            <h3>
                {% if score_percent >= 80 %}Monster Defeated! <i class="material-icons">emoji_events</i>{% elif score_percent >= 50 %}Monster Weakened! <i class="material-icons">star_half</i>{% else %}Monster Prevails! <i class="material-icons">replay</i>{% endif %}
            </h3>
            <p>
                {% if score_percent >= 80 %}
                    You've conquered this monster challenge with a <span class="monster-high-score">{{ score_percent|floatformat:1 }}%</span> score!
                {% elif score_percent >= 50 %}
                    You've fought well with a <span class="monster-high-score">{{ score_percent|floatformat:1 }}%</span> score!
                {% else %}
                    The monster was too strong this time with a <span class="monster-low-score">{{ score_percent|floatformat:1 }}%</span> score.
                {% endif %}
            </p>
            <p>You scored {{ attempt.score }}/{{ quiz.total_marks }} points.</p>
            <p>Time taken: {% if attempt.end_time %}{% with time_taken=attempt.end_time|timeuntil:attempt.start_time %}{{ time_taken }}{% endwith %}{% else %}N/A{% endif %}</p>
        </div>
        <div class="monster-detail-actions">
            <a href="{% url 'home:quiz_detail' quiz_id=quiz.id %}" class="monster-btn monster-btn-secondary">
                <span class="btn-content"><i class="material-icons">arrow_back</i> Back to Quiz</span>
            </a>
            <a href="{% url 'home:quiz_list' %}" class="monster-btn monster-btn-secondary">
                <span class="btn-content"><i class="material-icons">format_list_bulleted</i> All Quizzes</span>
            </a>
            {% if attempt.user == user %}
            <a href="{% url 'home:start_quiz' quiz_id=quiz.id %}" class="monster-btn monster-btn-primary">
                <span class="btn-content"><i class="material-icons">replay</i> Try Again</span>
            </a>
            {% endif %}
        </div>
        <h3 class="monster-review-title">Review Your Answers</h3>
        <div class="monster-questions-container">
            {% for question in questions %}
                {% with user_answer=user_answers.question.id %}
                <div class="monster-question-card">
                    <div class="question-number">Challenge #{{ forloop.counter }}</div>
                    <div class="question-text">{{ question.text }}</div>
                    {% if question.image %}
                    <div class="question-image">
                        <img src="{{ question.image.url }}" alt="Question image">
                    </div>
                    {% endif %}
                    <div class="question-answers">
                        {% if question.question_type == 'mcq' or question.question_type == 'true_false' %}
                            <div class="mcq-options monster-options">
                                {% for answer in question.answers.all %}
                                <div class="mcq-option monster-option">
                                    <label class="monster-option-label
                                        {% if answer.is_correct %}monster-correct-answer{% endif %}
                                        {% if user_answer.selected_answer == answer and not answer.is_correct %}monster-incorrect-answer{% endif %}
                                        {% if user_answer.selected_answer == answer %}monster-user-selected{% endif %}">
                                        {% if answer.is_correct %}
                                            <i class="material-icons" style="color: var(--monster-success);">check_circle</i>
                                        {% elif user_answer.selected_answer == answer %}
                                            <i class="material-icons" style="color: var(--monster-danger);">cancel</i>
                                        {% endif %}
                                        {{ answer.text }}
                                        {% if answer.is_correct %}<span style="color: var(--monster-success);">(Correct)</span>{% elif user_answer.selected_answer == answer %}<span style="color: var(--monster-danger);">(Your Answer)</span>{% endif %}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        {% elif question.question_type == 'short_answer' %}
                            <div class="short-answer monster-short-answer">
                                <div class="question-answer-comparison">
                                    <div class="user-answer">
                                        <h4>Your Answer:</h4>
                                        <div class="monster-textarea" style="{% if user_answer and user_answer.marks_obtained > 0 %}border-color: var(--monster-success); background-color: rgba(76, 175, 80, 0.1);{% else %}border-color: var(--monster-danger); background-color: rgba(244, 67, 54, 0.1);{% endif %}">
                                            {{ user_answer.text_answer|default:"No answer provided" }}
                                        </div>
                                    </div>
                                    <div class="correct-answer">
                                        <h4>Correct Answer:</h4>
                                        <div class="monster-textarea" style="border-color: var(--monster-success); background-color: rgba(76, 175, 80, 0.1);">
                                            {{ question.answers.all.0.text }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    {% if user_answer and user_answer.marks_obtained > 0 %}
                        <div class="monster-feedback" style="background-color: rgba(76, 175, 80, 0.1); border-left: 4px solid var(--monster-success); padding: 10px; margin-top: 15px;">
                            <i class="material-icons" style="color: var(--monster-success);">check_circle</i>
                            Correct! You earned {{ user_answer.marks_obtained }}/{{ question.marks }} points.
                        </div>
                    {% else %}
                        <div class="monster-feedback" style="background-color: rgba(244, 67, 54, 0.1); border-left: 4px solid var(--monster-danger); padding: 10px; margin-top: 15px;">
                            <i class="material-icons" style="color: var(--monster-danger);">cancel</i>
                            Incorrect. You earned 0 out of {{ question.marks }} possible points.
                        </div>
                    {% endif %}
                    {% if question.explanation %}
                    <div class="monster-explanation" style="background-color: rgba(156, 39, 176, 0.1); border-left: 4px solid var(--monster-primary); padding: 15px; margin-top: 15px;">
                        <h4><i class="material-icons">lightbulb</i> Explanation:</h4>
                        <p>{{ question.explanation }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endwith %}
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Monster eye animations
        const monsterEyes = document.querySelectorAll('.monster-eye');
        monsterEyes.forEach(eye => {
            const pupil = document.createElement('div');
            pupil.className = 'pupil';
            eye.appendChild(pupil);
        });
        document.addEventListener('mousemove', function(e) {
            const mouseX = e.clientX;
            const mouseY = e.clientY;
            monsterEyes.forEach(eye => {
                const eyeRect = eye.getBoundingClientRect();
                const eyeCenterX = eyeRect.left + eyeRect.width/2;
                const eyeCenterY = eyeRect.top + eyeRect.height/2;
                const deltaX = mouseX - eyeCenterX;
                const deltaY = mouseY - eyeCenterY;
                const maxMove = 3;
                const moveX = Math.min(Math.max(deltaX / 20, -maxMove), maxMove);
                const moveY = Math.min(Math.max(deltaY / 20, -maxMove), maxMove);
                eye.querySelector('.pupil')?.style.transform = `translate(${moveX}px, ${moveY}px)`;
            });
        });
        // Score animation
        const scoreValue = document.querySelector('.monster-score-value');
        if (scoreValue) {
            const finalScore = parseFloat(scoreValue.textContent);
            let currentScore = 0;
            const duration = 1500;
            const interval = 20;
            const increment = finalScore / (duration / interval);
            const timer = setInterval(() => {
                currentScore += increment;
                if (currentScore >= finalScore) {
                    clearInterval(timer);
                    currentScore = finalScore;
                }
                scoreValue.textContent = Math.floor(currentScore) + '%';
            }, interval);
        }
    });
</script>
{% endblock %}
